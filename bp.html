<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Blood Pressure & Heart Rate Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f7fb;
      margin: 0;
      padding: 20px;
      color: #222;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: #ffffff;
      padding: 20px 24px;
      border-radius: 12px;
      box-shadow: 0 8px 18px rgba(0,0,0,0.06);
    }
    h1 {
      margin-top: 0;
      font-size: 1.6rem;
      text-align: center;
    }
    p.subtitle {
      text-align: center;
      margin-top: 0;
      margin-bottom: 20px;
      font-size: 0.95rem;
      color: #555;
    }
    form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px 16px;
      margin-bottom: 16px;
      align-items: end;
    }
    label {
      font-size: 0.85rem;
      display: block;
      margin-bottom: 4px;
      color: #444;
    }
    input[type="number"],
    input[type="date"],
    input[type="time"],
    select {
      width: 100%;
      box-sizing: border-box;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 0.9rem;
    }
    input[type="number"]:focus,
    input[type="date"]:focus,
    input[type="time"]:focus,
    select:focus {
      outline: none;
      border-color: #4f46e5;
      box-shadow: 0 0 0 1px rgba(79,70,229,0.2);
    }
    button {
      padding: 8px 14px;
      border-radius: 8px;
      border: none;
      font-size: 0.9rem;
      cursor: pointer;
    }
    .btn-primary {
      background: #4f46e5;
      color: #fff;
    }
    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }
    .btn-danger {
      background: #ef4444;
      color: #fff;
    }
    .btn-primary:disabled,
    .btn-secondary:disabled,
    .btn-danger:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .status {
      margin: 6px 0 14px;
      font-size: 0.95rem;
    }
    .tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    .tag-low { background: #dbeafe; color: #1d4ed8; }
    .tag-normal { background: #dcfce7; color: #15803d; }
    .tag-average { background: #fef9c3; color: #854d0e; }
    .tag-high { background: #fee2e2; color: #b91c1c; }
    .tag-very-high { background: #fecaca; color: #7f1d1d; }

    .header-row {
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap:10px;
      margin-top:4px;
      margin-bottom:4px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 0.85rem;
      background: #f9fafb;
      border-radius: 8px;
      overflow: hidden;
    }
    thead {
      background: #e5e7eb;
    }
    th, td {
      padding: 8px 6px;
      text-align: center;
      border-bottom: 1px solid #e5e7eb;
    }
    tbody tr:nth-child(even) {
      background: #f3f4f6;
    }
    .footer-note {
      margin-top: 16px;
      font-size: 0.8rem;
      color: #6b7280;
    }
    @media (max-width: 640px) {
      form {
        grid-template-columns: 1fr 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Blood Pressure & Heart Rate Tracker</h1>
    <p class="subtitle">
      Track your readings and download them as an Excel-compatible CSV file.<br />
      Categories are for guidance only – always follow your GP’s advice.
    </p>

    <form id="bpForm">
      <div>
        <label for="date">Date</label>
        <input type="date" id="date" />
      </div>
      <div>
        <label for="time">Time</label>
        <input type="time" id="time" />
      </div>
      <div>
        <label for="sys">Systolic (upper, mmHg)</label>
        <input type="number" id="sys" min="60" max="260" required />
      </div>
      <div>
        <label for="dia">Diastolic (lower, mmHg)</label>
        <input type="number" id="dia" min="40" max="160" required />
      </div>
      <div>
        <label for="bpm">Heart rate (bpm)</label>
        <input type="number" id="bpm" min="30" max="200" required />
      </div>
      <div>
        <label for="feeling">How I felt</label>
        <select id="feeling">
          <option value="">Select…</option>
          <option value="Calm / relaxed">Calm / relaxed</option>
          <option value="Okay">Okay</option>
          <option value="A bit anxious">A bit anxious</option>
          <option value="Very anxious / panicky">Very anxious / panicky</option>
          <option value="Unwell">Unwell</option>
          <option value="Tired / exhausted">Tired / exhausted</option>
          <option value="Chest discomfort">Chest discomfort</option>
          <option value="Other">Other</option>
        </select>
      </div>
      <div>
        <button type="submit" class="btn-primary" style="width:100%;">Add reading</button>
      </div>
    </form>

    <div class="status" id="status"></div>

    <div class="header-row">
      <strong>Saved readings</strong>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <button id="downloadBtn" class="btn-secondary" disabled>Download CSV (Excel)</button>
        <button id="clearBtn" class="btn-danger" disabled>Clear all</button>
      </div>
    </div>

    <table id="bpTable">
      <thead>
        <tr>
          <th>#</th>
          <th>Date (UK)</th>
          <th>Time</th>
          <th>Systolic</th>
          <th>Diastolic</th>
          <th>Heart rate</th>
          <th>Feeling</th>
          <th>Category</th>
          <th>Remove</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <p class="footer-note">
    </p>
  </div>

  <script>
    // ===== Online API config =====
    const API_URL = "https://lightcyan-louse-528156.hostingersite.com/api.php";
";
    const API_KEY = "020619837323";

    const form = document.getElementById("bpForm");
    const statusDiv = document.getElementById("status");
    const tableBody = document.querySelector("#bpTable tbody");
    const downloadBtn = document.getElementById("downloadBtn");
    const clearBtn = document.getElementById("clearBtn");

    let readings = []; // now comes from server (MySQL)

    function setDefaultDateTime() {
      const now = new Date();
      const dateInput = document.getElementById("date");
      const timeInput = document.getElementById("time");

      const yyyy = now.getFullYear();
      const mm = String(now.getMonth() + 1).padStart(2, "0");
      const dd = String(now.getDate()).padStart(2, "0");
      dateInput.value = `${yyyy}-${mm}-${dd}`;

      const hh = String(now.getHours()).padStart(2, "0");
      const min = String(now.getMinutes()).padStart(2, "0");
      timeInput.value = `${hh}:${min}`;
    }

    function formatDateUK(iso) {
      if (!iso || typeof iso !== "string") return "";
      const parts = iso.split("-");
      if (parts.length !== 3) return iso;
      const [yyyy, mm, dd] = parts;
      return `${dd}/${mm}/${yyyy}`;
    }

    function classifyBP(sys, dia) {
      if (sys < 90 || dia < 60) return { label: "Low", className: "tag-low" };
      if (sys < 120 && dia < 80) return { label: "Normal", className: "tag-normal" };
      if (sys < 130 && dia < 80) return { label: "Average", className: "tag-average" };
      if (sys < 140 && dia < 90) return { label: "High", className: "tag-high" };
      return { label: "Very high", className: "tag-very-high" };
    }

    async function loadReadings() {
      try {
        const res = await fetch(API_URL);
        const data = await res.json();
        readings = Array.isArray(data) ? data : [];
        renderTable();
        downloadBtn.disabled = readings.length === 0;
        clearBtn.disabled = readings.length === 0;
      } catch (e) {
        console.error(e);
        statusDiv.textContent = "Could not load readings from server.";
        readings = [];
        renderTable();
        downloadBtn.disabled = true;
        clearBtn.disabled = true;
      }
    }

    async function addReadingToServer(reading) {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-API-KEY": API_KEY
        },
        body: JSON.stringify(reading)
      });

      const out = await res.json();
      if (!res.ok) throw new Error(out?.error || "Failed to save");

      await loadReadings();
    }

    async function deleteEntryById(id) {
      if (!confirm("Delete this entry?")) return;

      const res = await fetch(`${API_URL}?id=${encodeURIComponent(id)}`, {
        method: "DELETE",
        headers: { "X-API-KEY": API_KEY }
      });

      const out = await res.json();
      if (!res.ok) {
        alert(out?.error || "Delete failed");
        return;
      }

      statusDiv.textContent = "";
      await loadReadings();
    }

    async function clearAllReadings() {
      if (!confirm("Clear all saved readings?")) return;

      const res = await fetch(`${API_URL}?all=1`, {
        method: "DELETE",
        headers: { "X-API-KEY": API_KEY }
      });

      const out = await res.json();
      if (!res.ok) {
        alert(out?.error || "Clear failed");
        return;
      }

      readings = [];
      renderTable();
      statusDiv.textContent = "";
      downloadBtn.disabled = true;
      clearBtn.disabled = true;
    }

    function renderTable() {
      tableBody.innerHTML = "";

      // API returns newest first; keep your numbering as display order
      readings.forEach((r, index) => {
        // Map DB fields -> existing render expectations
        const dateIso = r.date_iso || "";
        const time = r.time_hm || "";
        const sys = Number(r.systolic);
        const dia = Number(r.diastolic);
        const bpm = Number(r.bpm);
        const feeling = r.feeling || "";

        const cat = classifyBP(sys, dia);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${index + 1}</td>
          <td>${formatDateUK(dateIso)}</td>
          <td>${time}</td>
          <td>${sys}</td>
          <td>${dia}</td>
          <td>${bpm}</td>
          <td>${feeling}</td>
          <td><span class="tag ${cat.className}">${cat.label}</span></td>
          <td>
            <button
              type="button"
              class="btn-danger"
              style="padding:3px 8px; font-size:0.8rem;"
              onclick="deleteEntryById(${r.id})"
            >
              Delete
            </button>
          </td>
        `;
        tableBody.appendChild(tr);
      });
    }

    function downloadCSV() {
      if (readings.length === 0) return;

      const header = [
        "Index",
        "Date (UK)",
        "Time",
        "Systolic",
        "Diastolic",
        "Heart rate",
        "Feeling",
        "Category"
      ];

      const rows = readings.map((r, i) => {
        const dateIso = r.date_iso || "";
        const time = r.time_hm || "";
        const sys = Number(r.systolic);
        const dia = Number(r.diastolic);
        const bpm = Number(r.bpm);
        const feeling = r.feeling || "";
        const dateUk = formatDateUK(dateIso);

        return [
          i + 1,
          dateUk,
          time,
          sys,
          dia,
          bpm,
          feeling,
          classifyBP(sys, dia).label
        ];
      });

      const csvContent = [header, ...rows]
        .map(row =>
          row
            .map(field => {
              const v = String(field ?? "");
              if (v.includes(",") || v.includes('"') || v.includes("\n")) {
                return `"${v.replace(/"/g, '""')}"`;
              }
              return v;
            })
            .join(",")
        )
        .join("\n");

      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "blood_pressure_readings.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    form.addEventListener("submit", (e) => {
      e.preventDefault();

      const dateIso = document.getElementById("date").value || "";
      const time = document.getElementById("time").value || "";
      const sys = parseInt(document.getElementById("sys").value, 10);
      const dia = parseInt(document.getElementById("dia").value, 10);
      const bpm = parseInt(document.getElementById("bpm").value, 10);
      const feeling = document.getElementById("feeling").value || "";

      if (isNaN(sys) || isNaN(dia) || isNaN(bpm)) {
        statusDiv.textContent = "Please fill in systolic, diastolic, and heart rate.";
        return;
      }

      const category = classifyBP(sys, dia);
      const dateUk = formatDateUK(dateIso);

      const reading = {
        dateIso,
        time,
        sys,
        dia,
        bpm,
        feeling
      };

      addReadingToServer(reading).then(() => {
        statusDiv.innerHTML = `
          Last added: ${dateUk || "(no date)"} ${time || ""} – ${sys}/${dia} mmHg, ${bpm} bpm,
          feeling: ${feeling || "n/a"}
          – <span class="tag ${category.className}">${category.label}</span>
        `;

        downloadBtn.disabled = false;
        clearBtn.disabled = false;
      }).catch((err) => {
        console.error(err);
        statusDiv.textContent = "Failed to save reading to server.";
      });
    });

    downloadBtn.addEventListener("click", downloadCSV);
    clearBtn.addEventListener("click", clearAllReadings);

    // expose for inline onclick delete
    window.deleteEntryById = deleteEntryById;

    // init
    setDefaultDateTime();
    loadReadings();
  </script>
</body>
</html>


