<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>IT Tickets Dashboard</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,sans-serif;background:#f5f7fb;margin:0;padding:20px;color:#111}
    .container{max-width:980px;margin:0 auto}
    .top{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-bottom:6px}
    h1{margin:0}
    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    select,button{padding:8px 10px;border-radius:10px;border:1px solid #ccc;background:#fff;cursor:pointer}
    button{border:none;background:#4f46e5;color:#fff}
    button.secondary{background:#e5e7eb;color:#111;border:1px solid #cbd5e1}

    .last-updated{
      font-size:.85rem;
      color:#555;
      margin-bottom:10px;
    }

    .grid{display:grid;gap:12px}

    .card{
      background:#fff;
      border-radius:14px;
      box-shadow:0 8px 18px rgba(0,0,0,.06);
      padding:14px 16px;
      border-left:10px solid #94a3b8;
      transition: transform .18s ease, box-shadow .18s ease, border-left-width .18s ease;
      will-change: transform;
    }

    .p-urgent{border-left-color:#ef4444}
    .p-medium{border-left-color:#f59e0b}
    .p-low{border-left-color:#22c55e}

    .card:hover{
      transform: translateY(-4px) scale(1.01);
      box-shadow:0 16px 30px rgba(0,0,0,.14);
      border-left-width:14px;
    }

    .meta{display:flex;gap:10px;flex-wrap:wrap;align-items:center;color:#555;font-size:.9rem;margin-top:6px}
    .pill{font-size:.78rem;font-weight:700;padding:3px 8px;border-radius:999px;background:#eef2ff;color:#3730a3}
    .status{margin-left:auto}
    .desc{margin:10px 0 0;white-space:pre-wrap}
    .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .msg{margin-top:10px;color:#b91c1c}

    .ticket-link{
      color: inherit;
      text-decoration: none;
      font-weight: 800;
    }
    .ticket-link:hover{text-decoration:underline}

    @media (prefers-reduced-motion: reduce){
      .card{transition:none}
      .card:hover{transform:none}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="top">
      <h1>IT Tickets</h1>
      <div class="controls">
        <select id="filterStatus">
          <option value="Open" selected>Open</option>
          <option value="In Progress">In Progress</option>
          <option value="Closed">Closed</option>
        </select>
        <button id="refreshBtn">Refresh</button>
        <button class="secondary" id="keyBtn">Set/Clear Admin Key</button>
      </div>
    </div>

    <div class="last-updated" id="lastUpdated"></div>
    <div class="msg" id="msg"></div>
    <div class="grid" id="grid"></div>
  </div>

  <script>
    const API_URL = "https://haldred1.org/tickets_api.php";
    const grid = document.getElementById("grid");
    const msg = document.getElementById("msg");
    const filterStatus = document.getElementById("filterStatus");
    const lastUpdated = document.getElementById("lastUpdated");

    function getAdminKey(promptIfMissing=true){
      let k = sessionStorage.getItem("IT_ADMIN_KEY") || "";
      if (!k && promptIfMissing){
        k = prompt("Enter IT admin key:") || "";
        if (k) sessionStorage.setItem("IT_ADMIN_KEY", k);
      }
      return k;
    }

    function clearAdminKey(){
      sessionStorage.removeItem("IT_ADMIN_KEY");
      alert("Admin key cleared.");
    }

    document.getElementById("keyBtn").addEventListener("click", () => {
      const current = sessionStorage.getItem("IT_ADMIN_KEY") || "";
      if (current && confirm("Clear saved admin key?")) clearAdminKey();
      else getAdminKey(true);
    });

    document.getElementById("refreshBtn").addEventListener("click", load);
    filterStatus.addEventListener("change", load);

    function ukTime(ts){
      const d = new Date(String(ts).replace(" ", "T") + "Z");
      return isNaN(d) ? ts : d.toLocaleString("en-GB",{dateStyle:"short",timeStyle:"short"});
    }

    function priorityClass(p){
      if (p === "Urgent") return "p-urgent";
      if (p === "Medium") return "p-medium";
      return "p-low";
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function makeTicketTitle(t){
      return (t.subject || t.description || "Ticket").split("\n")[0].slice(0,80);
    }

    async function safeJson(res){
      const text = await res.text();
      try { return JSON.parse(text); }
      catch { return { error: text || "Invalid server response" }; }
    }

    async function load(){
      msg.textContent = "";
      grid.innerHTML = "";

      const key = getAdminKey(true);
      if (!key){ msg.textContent="No admin key set."; return; }

      const status = filterStatus.value || "Open";
      const url = `${API_URL}?action=list&status=${encodeURIComponent(status)}&_=${Date.now()}`;

      try{
        const res = await fetch(url,{
          headers:{ "X-ADMIN-KEY": key },
          cache:"no-store"
        });

        const out = await safeJson(res);

        if (res.status === 401){
          sessionStorage.removeItem("IT_ADMIN_KEY");
          msg.textContent="Admin key rejected.";
          return;
        }
        if (!res.ok) throw new Error(out?.error || "Load failed");

        const tickets = Array.isArray(out) ? out : [];

        if (!tickets.length){
          grid.innerHTML="<div style='color:#555'>No tickets found.</div>";
        }

        tickets.forEach(t=>{
          const card=document.createElement("div");
          card.className=`card ${priorityClass(t.priority)}`;
          const link=`it-ticket.html?id=${encodeURIComponent(t.id)}`;

          card.innerHTML=`
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
              <a class="ticket-link" href="${link}">${escapeHtml(makeTicketTitle(t))}</a>
              <span class="pill">${escapeHtml(t.priority)}</span>
              <span class="pill status">${escapeHtml(t.status)}</span>
            </div>
            <div class="meta">
              <span><strong>#${t.id}</strong></span>
              <span>From: ${escapeHtml(t.requester_name || "")}${t.requester_email ? " ("+escapeHtml(t.requester_email)+")":""}</span>
              <span>Created: ${ukTime(t.created_at)}</span>
            </div>
            <div class="desc">${escapeHtml(t.description || "")}</div>
            <div class="row">
              <button class="secondary" onclick="location.href='${link}'">Open ticket</button>
            </div>
          `;
          grid.appendChild(card);
        });

        lastUpdated.textContent =
          "Last updated: " +
          new Date().toLocaleString("en-GB",{dateStyle:"short",timeStyle:"medium"});

      }catch(err){
        console.error(err);
        msg.textContent=err?.message||String(err);
      }
    }

    // Initial load
    load();

    // Auto-refresh every 30s (only when visible)
    setInterval(()=>{
      if (!document.hidden) load();
    },30000);

    // Refresh when tab becomes visible
    document.addEventListener("visibilitychange",()=>{
      if (!document.hidden) load();
    });
  </script>
</body>
</html>
