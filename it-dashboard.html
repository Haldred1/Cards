<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>IT Tickets Dashboard</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,sans-serif;background:#f5f7fb;margin:0;padding:20px;color:#111}
    .container{max-width:980px;margin:0 auto}
    .top{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-bottom:12px}
    h1{margin:0}
    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    select,button{padding:8px 10px;border-radius:10px;border:1px solid #ccc;background:#fff;cursor:pointer}
    button{border:none;background:#4f46e5;color:#fff}
    button.secondary{background:#e5e7eb;color:#111;border:1px solid #cbd5e1}

    .grid{display:grid;gap:12px}

    /* Card base */
    .card{
      background:#fff;
      border-radius:14px;
      box-shadow:0 8px 18px rgba(0,0,0,.06);
      padding:14px 16px;
      border-left:10px solid #94a3b8;

      /* Hover polish */
      transition: transform .18s ease, box-shadow .18s ease, border-left-width .18s ease;
      cursor: default;
      will-change: transform;
    }

    /* Priority borders */
    .p-urgent{border-left-color:#ef4444}
    .p-medium{border-left-color:#f59e0b}
    .p-low{border-left-color:#22c55e}

    /* Hover effect */
    .card:hover{
      transform: translateY(-4px) scale(1.01);
      box-shadow:0 16px 30px rgba(0,0,0,.14);
      border-left-width:14px;
    }

    .meta{display:flex;gap:10px;flex-wrap:wrap;align-items:center;color:#555;font-size:.9rem;margin-top:6px}
    .pill{font-size:.78rem;font-weight:700;padding:3px 8px;border-radius:999px;background:#eef2ff;color:#3730a3}
    .status{margin-left:auto}
    .desc{margin:10px 0 0;white-space:pre-wrap}
    .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .row select{border:1px solid #cbd5e1}
    .msg{margin-top:10px;color:#b91c1c}

    /* Link styling (task name like your work system) */
    .ticket-link{
      color: inherit;
      text-decoration: none;
      font-weight: 800;
    }
    .ticket-link:hover{
      text-decoration: underline;
    }

    /* Button hover micro-interaction */
    .card button{
      transition: transform .12s ease;
    }
    .card button:hover{
      transform: translateY(-1px);
    }

    /* Respect reduced motion accessibility */
    @media (prefers-reduced-motion: reduce){
      .card, .card button{transition:none}
      .card:hover{transform:none}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="top">
      <h1>IT Tickets</h1>
      <div class="controls">
        <select id="filterStatus">
          <option value="Open" selected>Open</option>
          <option value="In Progress">In Progress</option>
          <option value="Closed">Closed</option>
        </select>
        <button id="refreshBtn">Refresh</button>
        <button class="secondary" id="keyBtn">Set/Clear Admin Key</button>
      </div>
    </div>

    <div class="msg" id="msg"></div>
    <div class="grid" id="grid"></div>
  </div>

  <script>
    const API_URL = "https://haldred1.org/tickets_api.php";
    const grid = document.getElementById("grid");
    const msg = document.getElementById("msg");
    const filterStatus = document.getElementById("filterStatus");

    function getAdminKey(promptIfMissing=true){
      let k = sessionStorage.getItem("IT_ADMIN_KEY") || "";
      if (!k && promptIfMissing){
        k = prompt("Enter IT admin key:") || "";
        if (k) sessionStorage.setItem("IT_ADMIN_KEY", k);
      }
      return k;
    }

    function clearAdminKey(){
      sessionStorage.removeItem("IT_ADMIN_KEY");
      alert("Admin key cleared.");
    }

    document.getElementById("keyBtn").addEventListener("click", () => {
      const current = sessionStorage.getItem("IT_ADMIN_KEY") || "";
      if (current && confirm("Clear saved admin key?")) clearAdminKey();
      else getAdminKey(true);
    });

    document.getElementById("refreshBtn").addEventListener("click", load);
    filterStatus.addEventListener("change", load);

    function ukTime(ts){
      // expects MySQL "YYYY-MM-DD HH:MM:SS"
      const d = new Date(ts.replace(" ", "T") + "Z"); // rough parse
      if (isNaN(d.getTime())) return ts;
      return d.toLocaleString("en-GB", { dateStyle:"short", timeStyle:"short" });
    }

    function priorityClass(p){
      if (p === "Urgent") return "p-urgent";
      if (p === "Medium") return "p-medium";
      return "p-low";
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function makeTicketTitle(t){
      const subject = (t.subject || "").trim();
      if (subject) return subject;
      // fallback: first line of description
      const d = (t.description || "").trim();
      if (!d) return "Ticket";
      return d.split("\n")[0].slice(0, 80);
    }

    async function load(){
      msg.textContent = "";
      grid.innerHTML = "";

      const key = getAdminKey(true);
      if (!key) { msg.textContent = "No admin key set."; return; }

      const status = filterStatus.value || "Open";
      const url = `${API_URL}?action=list&status=${encodeURIComponent(status)}`;

      try{
        const res = await fetch(url, {
          headers: { "X-ADMIN-KEY": key }
        });

        const out = await res.json().catch(()=>null);

        if (res.status === 401){
          sessionStorage.removeItem("IT_ADMIN_KEY");
          msg.textContent = "Admin key rejected. Please try again.";
          return;
        }
        if (!res.ok) throw new Error(out?.error || `Load failed (HTTP ${res.status})`);

        const tickets = Array.isArray(out) ? out : [];

        if (tickets.length === 0){
          grid.innerHTML = `<div style="color:#555">No tickets found.</div>`;
          return;
        }

        tickets.forEach(t => {
          const card = document.createElement("div");
          card.className = `card ${priorityClass(t.priority)}`;

          const title = escapeHtml(makeTicketTitle(t));
          const subject = escapeHtml((t.subject || "").trim());
          const requester = escapeHtml(t.requester_name || "");
          const email = t.requester_email ? ` (${escapeHtml(t.requester_email)})` : "";

          // Link to IT ticket detail page (same folder as this dashboard page)
          const detailHref = `it-ticket.html?id=${encodeURIComponent(t.id)}`;

          card.innerHTML = `
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
              <div>
                <a class="ticket-link" href="${detailHref}" title="Open ticket #${t.id}">
                  ${title}
                </a>
              </div>
              <span class="pill">${escapeHtml(t.priority)}</span>
              <span class="pill status">${escapeHtml(t.status)}</span>
            </div>

            <div class="meta">
              <span><strong>#${t.id}</strong></span>
              <span>From: ${requester}${email}</span>
              <span>Created: ${ukTime(t.created_at)}</span>
            </div>

            ${subject ? `<div class="desc" style="margin-top:8px;"><strong>Subject:</strong> ${subject}</div>` : ""}

            <div class="desc">${escapeHtml(t.description || "")}</div>

            <div class="row">
              <button class="secondary" type="button" onclick="location.href='${detailHref}'">
                Open ticket
              </button>
            </div>
          `;

          grid.appendChild(card);
        });

      } catch(err){
        console.error(err);
        msg.textContent = err?.message || String(err);
      }
    }

    // init
    load();
  </script>
</body>
</html>

