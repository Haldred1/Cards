<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Member Platform</title>

<style>
body{font-family:system-ui,-apple-system,Segoe UI,sans-serif;background:#f5f7fb;margin:0;padding:20px}
.container{max-width:1000px;margin:auto}
.card{background:#fff;border-radius:16px;padding:18px;margin-bottom:14px;box-shadow:0 10px 22px rgba(0,0,0,.08)}
.top{display:flex;justify-content:space-between;align-items:center}
button{padding:10px 14px;border-radius:12px;border:none;background:#4f46e5;color:#fff;font-weight:700;cursor:pointer}
.msg{color:#b91c1c}
.ok{color:#15803d}
</style>
</head>

<body>
<div class="container">

<div class="top">
  <h1>Member Platform</h1>
  <button id="logout">Logout</button>
</div>

<div class="card">
  <div id="who"></div>
  <div style="font-size:2rem;font-weight:900" id="cash">â€”</div>
</div>

<div class="msg" id="msg"></div>

</div>

<script>
const API_URL = "https://haldred1.org/sipp_api.php";
const TOKEN_KEY = "SIPP_MEMBER_TOKEN";

function token(){
  return localStorage.getItem(TOKEN_KEY);
}

function authHeaders(){
  const t = token();
  return t ? { "Authorization": "Bearer " + t } : {};
}

async function apiGet(action){
  const res = await fetch(`${API_URL}?action=${action}`, {
    headers: authHeaders()
  });
  const out = await res.json().catch(()=>null);

  if(res.status === 401){
    localStorage.removeItem(TOKEN_KEY);
    location.href = "sipp-login.html?mode=member";
    return;
  }
  if(!res.ok) throw new Error(out?.error || "Request failed");
  return out;
}

async function load(){
  try{
    const out = await apiGet("me");
    if(!out) return;

    document.getElementById("who").textContent =
      `${out.user.email} (${out.user.role})`;

    document.getElementById("cash").textContent =
      "Â£" + (out.account?.cash_balance || "0.00");

  }catch(e){
    document.getElementById("msg").textContent = e.message;
  }
}

document.getElementById("logout").onclick = () => {
  localStorage.removeItem(TOKEN_KEY);
  location.href = "sipp-login.html?mode=member";
};

// ðŸš€ INIT
if(!token()){
  location.href = "sipp-login.html?mode=member";
}else{
  load();
}
</script>
</body>
</html>
