<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>SIPP Member Platform</title>

  <style>
    *{box-sizing:border-box}
    body{
      font-family:system-ui,-apple-system,Segoe UI,sans-serif;
      background:#f5f7fb;
      margin:0;
      padding:20px;
      color:#111;
    }
    .container{max-width:1200px;margin:0 auto}
    .top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:12px;
    }
    h1{margin:0}

    /* Tabs */
    .tabs{
      display:flex;
      gap:8px;
      margin:12px 0 18px;
    }
    .tab{
      padding:10px 18px;
      border-radius:12px;
      border:1px solid #cbd5e1;
      background:#f8fafc;
      font-weight:800;
      cursor:pointer;
      color:#334155;
    }
    .tab.active{
      background:#4f46e5;
      color:#fff;
      border-color:#4f46e5;
    }

    .card{
      background:#fff;
      border-radius:16px;
      padding:16px 18px;
      box-shadow:0 10px 22px rgba(0,0,0,.08);
      margin-bottom:16px;
    }
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(320px,1fr));
      gap:16px;
    }
    .pill{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      font-size:.75rem;
      font-weight:800;
      background:#eef2ff;
      color:#3730a3;
    }
    label{font-size:.85rem;color:#444}
    input,select,textarea,button{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid #cbd5e1;
      font-size:1rem;
      margin-top:6px;
    }
    textarea{min-height:90px}
    button{
      border:none;
      background:#4f46e5;
      color:#fff;
      font-weight:800;
      cursor:pointer;
    }
    button.secondary{
      background:#e5e7eb;
      color:#111;
      border:1px solid #cbd5e1;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:.92rem;
    }
    th,td{
      padding:10px 8px;
      border-bottom:1px solid #e5e7eb;
      text-align:left;
    }
    th{background:#f3f4f6}
    .msg{margin-top:8px;color:#b91c1c}
    .ok{color:#15803d}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .right{margin-left:auto}
  </style>
</head>

<body>
<div class="container">

  <div class="top">
    <div>
      <h1>Member Platform</h1>
      <div id="who" style="margin-top:4px;color:#555"></div>
    </div>
    <button id="logoutBtn" class="secondary">Logout</button>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab active" data-tab="overview">Overview</button>
    <button class="tab" data-tab="transactions">Transactions</button>
  </div>

  <!-- ================= OVERVIEW TAB ================= -->
  <div id="tab-overview" class="tab-panel">

    <!-- ACCOUNT -->
    <div class="card">
      <div class="row">
        <div>
          <div style="font-size:.9rem;color:#555">Cash balance</div>
          <div style="font-size:2.2rem;font-weight:900" id="cash">£0.00</div>
          <div id="sippRef" style="margin-top:4px;color:#555"></div>
        </div>
        <span class="pill right">Member</span>
      </div>
    </div>

    <div class="grid">
      <!-- DEPOSIT -->
      <div class="card">
        <h3>Deposit demo cash</h3>
        <label>Amount (£)</label>
        <input id="depositAmount" placeholder="100.00"/>
        <button id="depositBtn" style="margin-top:10px">Deposit</button>
        <div id="depositMsg" class="msg"></div>
      </div>

      <!-- BUY -->
      <div class="card">
        <h3>Buy investment</h3>
        <label>Investment</label>
        <select id="buyInv"></select>
        <label style="margin-top:10px">Amount (£)</label>
        <input id="buyAmount" placeholder="50.00"/>
        <button id="buyBtn" style="margin-top:10px">Buy</button>
        <div id="buyMsg" class="msg"></div>
      </div>

      <!-- SELL -->
      <div class="card">
        <h3>Sell investment</h3>
        <label>Holding</label>
        <select id="sellHolding"></select>
        <label style="margin-top:10px">Units</label>
        <input id="sellUnits" placeholder="0.500000"/>
        <button id="sellBtn" style="margin-top:10px">Sell</button>
        <div id="sellMsg" class="msg"></div>
      </div>
    </div>

    <!-- HOLDINGS -->
    <div class="card">
      <h3>Holdings</h3>
      <table>
        <thead>
          <tr>
            <th>Code</th><th>Name</th><th>Risk</th><th>Price</th><th>Units</th>
          </tr>
        </thead>
        <tbody id="holdingsBody"></tbody>
      </table>
    </div>

    <!-- PAYOUT REQUEST -->
    <div class="grid">
      <div class="card">
        <h3>Request payout</h3>

        <label>Type</label>
        <select id="reqType">
          <option>Income</option>
          <option>TFC</option>
          <option>Income+TFC</option>
        </select>

        <label style="margin-top:10px">Frequency</label>
        <select id="reqFreq">
          <option>Single</option>
          <option>Monthly</option>
        </select>

        <label style="margin-top:10px">Payout date (optional)</label>
        <input id="reqDate"/>

        <label style="margin-top:10px">Income amount (£)</label>
        <input id="reqIncome"/>

        <label style="margin-top:10px">TFC amount (£)</label>
        <input id="reqTfc"/>

        <button id="reqBtn" style="margin-top:12px">Submit request</button>
        <div id="reqMsg" class="msg"></div>
      </div>

      <div class="card">
        <h3>My payout requests</h3>
        <table>
          <thead>
            <tr>
              <th>#</th><th>Type</th><th>Freq</th><th>Date</th>
              <th>Income</th><th>TFC</th><th>Status</th>
            </tr>
          </thead>
          <tbody id="reqBody"></tbody>
        </table>
      </div>
    </div>

  </div>

  <!-- ================= TRANSACTIONS TAB ================= -->
  <div id="tab-transactions" class="tab-panel" style="display:none">
    <div class="card">
      <h3>Transactions</h3>
      <div class="muted" style="margin-bottom:10px">
        All money movements on your SIPP.
      </div>
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Type</th>
            <th>Direction</th>
            <th>Amount</th>
          </tr>
        </thead>
        <tbody id="txBody">
          <tr><td colspan="4" class="muted">Transactions will appear here.</td></tr>
        </tbody>
      </table>
    </div>
  </div>

</div>

<script>
const API="https://haldred1.org/sipp_api.php";
const TOKEN_KEY="SIPP_MEMBER_TOKEN";
function token(){return localStorage.getItem(TOKEN_KEY)||""}
function auth(){return{"Authorization":"Bearer "+token()}}
function money(v){return "£"+(v||"0.00")}
function msg(el,t,ok=false){el.textContent=t||"";el.className="msg"+(ok?" ok":"")}

async function apiGet(a){
  const r=await fetch(`${API}?action=${a}`,{headers:auth()});
  const j=await r.json();
  if(!r.ok) throw new Error(j.error);
  return j;
}
async function apiPost(a,d){
  const r=await fetch(`${API}?action=${a}`,{
    method:"POST",
    headers:{...auth(),"Content-Type":"application/json"},
    body:JSON.stringify(d||{})
  });
  const j=await r.json();
  if(!r.ok) throw new Error(j.error);
  return j;
}

/* Tabs */
document.querySelectorAll(".tab").forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    b.classList.add("active");
    document.querySelectorAll(".tab-panel").forEach(p=>p.style.display="none");
    document.getElementById("tab-"+b.dataset.tab).style.display="block";
  };
});

/* Existing logic */
async function loadAll(){
  const me=await apiGet("me");
  document.getElementById("who").textContent=`${me.user.email} (member)`;
  document.getElementById("cash").textContent=money(me.account.cash_balance);
  document.getElementById("sippRef").textContent=`SIPP ref: ${me.member.sipp_ref}`;
  const invs=await apiGet("investments");
  buyInv.innerHTML="";
  invs.forEach(i=>{
    const o=document.createElement("option");
    o.value=i.id;o.textContent=`${i.code} — ${i.name}`;buyInv.appendChild(o);
  });
  const port=await apiGet("my_portfolio");
  holdingsBody.innerHTML="";
  sellHolding.innerHTML="";
  port.holdings.forEach(h=>{
    holdingsBody.innerHTML+=`<tr><td>${h.code}</td><td>${h.name}</td><td>${h.risk}</td><td>${h.price_pennies}</td><td>${(+h.units).toFixed(6)}</td></tr>`;
    const o=document.createElement("option");
    o.value=h.investment_id;o.textContent=`${h.code} (${(+h.units).toFixed(6)})`;sellHolding.appendChild(o);
  });
  const reqs=await apiGet("my_payout_requests");
  reqBody.innerHTML="";
  reqs.forEach(r=>{
    reqBody.innerHTML+=`<tr><td>${r.id}</td><td>${r.request_type}</td><td>${r.frequency}</td><td>${r.payout_date||"ASAP"}</td><td>${money(r.income_amount)}</td><td>${money(r.tfc_amount)}</td><td>${r.status}</td></tr>`;
  });
}

logoutBtn.onclick=()=>{localStorage.removeItem(TOKEN_KEY);location.href="sipp-login.html";}
depositBtn.onclick=async()=>{await apiPost("deposit",{amount:depositAmount.value});loadAll();}
buyBtn.onclick=async()=>{await apiPost("buy",{investment_id:+buyInv.value,amount:buyAmount.value});loadAll();}
sellBtn.onclick=async()=>{await apiPost("sell",{investment_id:+sellHolding.value,units:+sellUnits.value});loadAll();}
reqBtn.onclick=async()=>{await apiPost("create_payout_request",{request_type:reqType.value,frequency:reqFreq.value,payout_date:reqDate.value,income_amount:reqIncome.value,tfc_amount:reqTfc.value});loadAll();}

if(!token()) location.href="sipp-login.html"; else loadAll();
</script>

</body>
</html>
