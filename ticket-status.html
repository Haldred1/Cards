<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Ticket Status</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,sans-serif;background:#f5f7fb;margin:0;padding:20px;color:#111}
    .container{max-width:820px;margin:0 auto;background:#fff;border-radius:12px;box-shadow:0 8px 18px rgba(0,0,0,.06);padding:20px 24px}
    .meta{color:#555;margin-top:6px}
    .thread{margin-top:14px;display:grid;gap:10px}
    .bubble{padding:10px 12px;border-radius:12px;border:1px solid #e5e7eb;background:#f9fafb}
    .bubble.it{border-left:6px solid #4f46e5}
    .bubble.user{border-left:6px solid #22c55e}
    .small{font-size:.85rem;color:#666;margin-top:4px}
    textarea,input{width:100%;box-sizing:border-box;padding:10px;border:1px solid #ccc;border-radius:10px;font-size:1rem}
    textarea{min-height:110px;resize:vertical}
    button{margin-top:10px;background:#4f46e5;color:#fff;border:none;border-radius:10px;padding:10px 14px;font-size:1rem;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .err{color:#b91c1c;margin-top:10px}
  </style>
</head>
<body>
  <div class="container">
    <h1 style="margin:0;">Ticket status</h1>
    <div class="meta" id="meta"></div>

    <div class="thread" id="thread"></div>

    <h3 style="margin-top:18px;">Reply</h3>
    <label>Your name</label>
    <input id="authorName" placeholder="Your name"/>

    <label style="margin-top:10px;display:block;">Message</label>
    <textarea id="message" placeholder="Type your reply..."></textarea>
    <button id="sendBtn">Send reply</button>
    <div class="err" id="err"></div>
  </div>

  <script>
    const API_URL = "https://lightcyan-louse-528156.hostingersite.com/tickets_api.php";

    const meta = document.getElementById("meta");
    const thread = document.getElementById("thread");
    const err = document.getElementById("err");
    const sendBtn = document.getElementById("sendBtn");

    const token = new URLSearchParams(location.search).get("token") || "";

    function esc(s){
      return String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }
    function ukTime(ts){
      const d = new Date(ts.replace(" ", "T") + "Z");
      return isNaN(d.getTime()) ? ts : d.toLocaleString("en-GB", {dateStyle:"short", timeStyle:"short"});
    }

    async function load(){
      err.textContent = "";
      thread.innerHTML = "";

      if (!token){
        err.textContent = "Missing token in URL.";
        return;
      }

      const res = await fetch(`${API_URL}?action=detail&token=${encodeURIComponent(token)}`);
      const out = await res.json().catch(()=>null);
      if (!res.ok) { err.textContent = out?.error || "Failed to load"; return; }

      const t = out.ticket;
      meta.innerHTML = `
        <strong>#${t.id}</strong> — ${esc(t.subject)}<br/>
        Status: <strong>${esc(t.status)}</strong> • Priority: <strong>${esc(t.priority)}</strong><br/>
        Created: ${ukTime(t.created_at)}
      `;

      (out.comments || []).forEach(c => {
        const div = document.createElement("div");
        div.className = "bubble " + (c.author_role === "IT" ? "it" : "user");
        div.innerHTML = `
          <div><strong>${esc(c.author_role)}:</strong> ${esc(c.author_name)}</div>
          <div style="margin-top:6px;white-space:pre-wrap">${esc(c.message)}</div>
          <div class="small">${ukTime(c.created_at)}</div>
        `;
        thread.appendChild(div);
      });

      // prefill name if empty
      const nameInput = document.getElementById("authorName");
      if (!nameInput.value) nameInput.value = t.requester_name || "";
    }

    async function send(){
      err.textContent = "";
      const authorName = document.getElementById("authorName").value.trim();
      const message = document.getElementById("message").value.trim();
      if (!message) { err.textContent = "Please type a message."; return; }

      sendBtn.disabled = true;
      try{
        const res = await fetch(`${API_URL}?action=add_comment`, {
          method:"POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ token, authorName, message })
        });
        const out = await res.json().catch(()=>null);
        if (!res.ok) throw new Error(out?.error || "Send failed");

        document.getElementById("message").value = "";
        await load();
      } catch(e){
        console.error(e);
        err.textContent = e?.message || String(e);
      } finally {
        sendBtn.disabled = false;
      }
    }

    sendBtn.addEventListener("click", send);
    load();
  </script>
</body>
</html>
